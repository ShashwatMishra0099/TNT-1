<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Capture Photo and Upload to Supabase</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin-top: 2rem;
      }
      video, canvas {
        border: 1px solid #ccc;
      }
      #message {
        margin-top: 1rem;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>Capture Photo and Upload to Supabase</h1>
    <video id="video" width="640" height="480" autoplay></video>
    <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
    <br />
    <button id="capture">Capture</button>
    <p id="message"></p>

    <!-- Load Supabase client library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      // Check if getUserMedia is supported
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        document.getElementById("message").textContent =
          "getUserMedia is not supported in your browser.";
        console.error("getUserMedia is not supported.");
      } else {
        console.log("getUserMedia is supported.");
      }

      // Initialize Supabase with your credentials
      const SUPABASE_URL = "https://kctklrigzowizlxlblat.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtjdGtscmlnem93aXpseGxibGF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzkxMDAxODgsImV4cCI6MjA1NDY3NjE4OH0.SiqrHjSbZsEEcqtkjnNPCgR839HJIeO_uqhYk7E83Hk";
      const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // Get element references
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const captureButton = document.getElementById("capture");
      const messageEl = document.getElementById("message");

      // Initialize camera stream
      async function initCamera() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: true });
          video.srcObject = stream;
          await video.play();
          console.log("Camera stream started successfully.");
        } catch (err) {
          console.error("Error accessing camera:", err);
          messageEl.textContent = "Error accessing camera: " + err.message;
        }
      }

      // Capture photo and upload to Supabase
      async function captureAndUpload() {
        const context = canvas.getContext("2d");
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(async (blob) => {
          if (!blob) {
            messageEl.textContent = "Could not capture photo.";
            return;
          }
          const fileName = "photo_" + Date.now() + ".png";
          try {
            const { data, error } = await supabase.storage
              .from("Test")
              .upload(fileName, blob, {
                cacheControl: "3600",
                upsert: false,
              });
            if (error) {
              console.error("Upload error:", error);
              messageEl.textContent = "Upload error: " + error.message;
            } else {
              console.log("Upload successful:", data);
              messageEl.textContent = "Photo uploaded successfully as " + fileName;
            }
          } catch (uploadErr) {
            console.error("Error uploading file:", uploadErr);
            messageEl.textContent = "Error uploading file: " + uploadErr.message;
          }
        }, "image/png");
      }

      captureButton.addEventListener("click", captureAndUpload);

      // Start camera on page load
      window.addEventListener("load", initCamera);
    </script>
  </body>
</html>
