<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Chatbot — Text & Image Studio</title>

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* =========================
       Theme tokens (dark pro)
       ========================= */
    :root{
      --bg-0: #0b0f18;   /* page background */
      --bg-1: #0f1620;   /* panels */
      --panel-grad: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.005));
      --muted: #98a6b6;
      --text: #e6f2ff;
      --accent-a: #69d3ff;
      --accent-b: #4cc9f0;
      --glass: rgba(255,255,255,0.03);
      --glass-2: rgba(255,255,255,0.02);
      --success: #10b981;
      --danger: #fb7185;
      --radius: 14px;
      --shadow-1: 0 8px 30px rgba(2,6,23,0.7);
      --tiny: 10px;
    }

    /* =========================
       Reset & typography
       ========================= */
    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; background: radial-gradient(1200px 600px at 10% 10%, rgba(76,201,240,0.04), transparent), var(--bg-0); color:var(--text); font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    a { color:var(--accent-a); text-decoration:none; }
    button { font-family:inherit; }

    /* =========================
       Header
       ========================= */
    header.app-header {
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:18px 20px; background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-bottom: 1px solid rgba(255,255,255,0.02);
      position:sticky; top:0; z-index:40;
      backdrop-filter: blur(6px);
    }
    .brand { display:flex; gap:12px; align-items:center; }
    .brand .logo {
      width:44px; height:44px; border-radius:12px; display:flex; align-items:center; justify-content:center;
      background: linear-gradient(135deg, var(--accent-b), var(--accent-a)); color:#002; font-weight:800; box-shadow: 0 6px 20px rgba(76,201,240,0.06);
      font-size:15px;
    }
    .brand h1 { margin:0; font-size:16px; color:var(--text); }
    .brand p { margin:0; font-size:12px; color:var(--muted); margin-top:2px; }

    .header-actions { display:flex; gap:10px; align-items:center; }
    .status-pill { font-size:12px; color:var(--muted); padding:8px 10px; border-radius:999px; background:transparent; border:1px solid rgba(255,255,255,0.02); }

    /* =========================
       App layout (responsive)
       ========================= */
    .container {
      max-width:1200px; margin:20px auto; padding:12px; display:grid; gap:18px;
      grid-template-columns: 320px 1fr;
      align-items:start;
    }

    /* Sidebar */
    .sidebar {
      background:var(--bg-1);
      border-radius:var(--radius);
      padding:14px;
      border:1px solid var(--glass-2);
      box-shadow: var(--shadow-1);
      display:flex; flex-direction:column; gap:12px; min-height:520px;
    }
    .sidebar h2 { margin:0; font-size:13px; color:var(--text); }
    .convo-list { display:flex; flex-direction:column; gap:10px; overflow:auto; padding-right:6px; }
    .convo {
      display:flex; gap:12px; padding:10px; border-radius:10px; align-items:center;
      transition: all .12s ease; cursor:pointer; border:1px solid transparent;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
    }
    .convo:hover { transform:translateY(-4px); box-shadow: 0 12px 30px rgba(2,6,23,0.45); }
    .avatar {
      width:44px; height:44px; border-radius:10px; background: linear-gradient(135deg,#1f2937,#0b1220);
      display:flex; align-items:center; justify-content:center; color:#e6f2ff; font-weight:700;
    }
    .convo .meta small { display:block; color:var(--muted); font-size:12px; margin-top:2px; }

    .sidebar .sidebar-controls { margin-top:auto; display:flex; gap:8px; }
    .btn {
      display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); background:transparent; color:var(--text); font-weight:600; cursor:pointer;
    }
    .btn.primary { background: linear-gradient(90deg,var(--accent-b),var(--accent-a)); color:#001; box-shadow: 0 8px 20px rgba(76,201,240,0.06); border:none; }

    /* Main panel */
    .panel {
      background: var(--panel-grad);
      border-radius:var(--radius);
      border:1px solid var(--glass-2);
      box-shadow: var(--shadow-1);
      min-height:520px; display:flex; flex-direction:column; overflow:hidden;
    }

    /* Tabs */
    .tabs { display:flex; gap:10px; align-items:center; padding:12px 16px; border-bottom:1px solid rgba(255,255,255,0.02); }
    .tab { font-weight:700; padding:8px 12px; border-radius:10px; color:var(--muted); cursor:pointer; }
    .tab.active { color:var(--accent-a); background: linear-gradient(90deg, rgba(125,211,252,0.06), rgba(76,201,240,0.03)); border:1px solid rgba(125,211,252,0.04); }

    /* Chat area */
    .chat-shell { display:flex; flex-direction:column; height:100%; }
    .messages {
      flex:1; overflow:auto; padding:18px; display:flex; flex-direction:column; gap:12px; scroll-behavior:smooth;
    }

    /* Message bubble styles */
    .msg {
      max-width:78%; padding:12px 14px; border-radius:12px; line-height:1.45; font-size:14px; position:relative;
      box-shadow: 0 6px 22px rgba(2,6,23,0.45);
    }
    .msg.user { margin-left:auto; background: linear-gradient(180deg, var(--accent-b), var(--accent-a)); color:#001; border-bottom-right-radius:8px; }
    .msg.bot { margin-right:auto; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.005)); color:var(--text); border-bottom-left-radius:8px; border:1px solid rgba(255,255,255,0.02); }
    .msg .meta { margin-top:8px; display:flex; gap:8px; align-items:center; color:var(--muted); font-size:12px; }

    /* Image bubble */
    .msg img { width:100%; border-radius:10px; display:block; margin-top:10px; box-shadow: 0 12px 38px rgba(2,6,23,0.6); }
    .image-actions { margin-top:8px; display:flex; gap:8px; }
    .small { padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:transparent; color:var(--muted); cursor:pointer; font-weight:600; font-size:13px; }

    /* Composer (sticky) */
    .composer {
      padding:14px; border-top:1px solid rgba(255,255,255,0.02); display:flex; gap:12px; align-items:center; background: linear-gradient(180deg, rgba(255,255,255,0.002), transparent);
    }
    .composer .input {
      flex:1; display:flex; gap:8px; align-items:center;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      padding:8px; border-radius:12px; border:1px solid rgba(255,255,255,0.02);
    }
    .composer input[type="text"] {
      border:0; outline:none; background:transparent; color:var(--text); font-size:15px; padding:10px; width:100%;
    }
    .composer .send {
      padding:10px 14px; border-radius:10px; background:linear-gradient(90deg,var(--accent-b),var(--accent-a)); border:none; color:#001; font-weight:800; cursor:pointer;
    }
    .composer .icon-btn { width:44px; height:44px; border-radius:10px; display:inline-flex; align-items:center; justify-content:center; background:transparent; border:1px solid rgba(255,255,255,0.02); color:var(--muted); cursor:pointer; }

    /* empty state */
    .empty {
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; color:var(--muted); padding:40px;
    }

    /* small screens */
    @media (max-width:920px) {
      .container { grid-template-columns: 1fr; padding:12px; }
      .sidebar { order:2; min-height:180px; display:flex; flex-direction:row; overflow:auto; gap:8px; padding:10px; align-items:center; }
      .convo { min-width:220px; flex:0 0 auto; }
      header.app-header { padding:12px; }
      .tab { font-size:13px; padding:8px 10px; }
    }
    @media (max-width:420px) {
      .brand h1 { font-size:14px; }
      .compose-aux { display:none; }
      .msg { font-size:15px; }
      .container { margin:12px 8px; }
    }

    /* subtle animations */
    .fade-in { animation: fadeIn .16s ease both; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(6px); } to { opacity:1; transform:none; } }

    /* spinner */
    .spinner {
      width:18px;height:18px;border-radius:50%;border:2px solid rgba(255,255,255,0.08);border-top-color:var(--accent-a); animation:spin .9s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }

  </style>
</head>
<body>
  <header class="app-header" role="banner">
    <div class="brand">
      <div class="logo" aria-hidden>AI</div>
      <div>
        <h1>AI Chatbot</h1>
        <p>Text Assistant • Image Studio</p>
      </div>
    </div>

    <div class="header-actions" aria-hidden>
      <div class="status-pill">Connected</div>
      <button class="btn" id="newConvoBtn" title="New conversation">+ New</button>
    </div>
  </header>

  <main class="container" role="main">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="Conversations">
      <h2>Conversations</h2>
      <div class="convo-list" id="convoList" aria-live="polite"></div>

      <div class="sidebar-controls" style="margin-top:auto">
        <button class="btn" id="clearAll">Clear</button>
        <button class="btn primary" id="startNew">New Chat</button>
      </div>
    </aside>

    <!-- Main panel -->
    <section class="panel" aria-label="Main">
      <div class="tabs" role="tablist" aria-label="Modes">
        <div class="tab active" data-tab="chat" role="tab" id="tab-chat" aria-selected="true">💬 Chat</div>
        <div class="tab" data-tab="image" role="tab" id="tab-image">🖼 Image Studio</div>
        <div style="margin-left:auto" class="status-pill" id="modeHint">Tip: Switch modes — Image Studio accepts prompts directly.</div>
      </div>

      <div class="chat-shell" id="chatShell">
        <div class="messages" id="messages" role="log" aria-live="polite">
          <div class="empty" id="emptyState">
            <div style="font-size:18px;font-weight:700">Welcome — get started</div>
            <div style="max-width:520px;color:var(--muted)">Switch to <strong>Image Studio</strong> to generate images directly (no <code>/generate</code> needed). Use the left panel to manage conversations. Each generated image includes a download button.</div>
          </div>
        </div>

        <div class="composer" role="region" aria-label="Message composer">
          <div class="input" role="search">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden style="opacity:.7"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"></circle></svg>
            <input id="txtInput" type="text" placeholder="Type a message..." autocomplete="off" aria-label="Message input">
          </div>

          <button class="icon-btn" id="attachBtn" title="Attach (not implemented)" aria-hidden>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 12.5V6a5 5 0 0 0-10 0v7a3 3 0 0 0 6 0V7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" opacity="0.75"/></svg>
          </button>

          <button class="send" id="sendBtn" title="Send message">Send</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    /* =========================
       Minimal, robust app logic
       (preserves previous endpoints & behavior)
       ========================= */

    const convoListEl = document.getElementById('convoList');
    const messagesEl = document.getElementById('messages');
    const emptyState = document.getElementById('emptyState');
    const tabs = document.querySelectorAll('.tab');
    const txtInput = document.getElementById('txtInput');
    const sendBtn = document.getElementById('sendBtn');
    const newConvoBtn = document.getElementById('newConvoBtn');
    const startNew = document.getElementById('startNew');
    const clearAllBtn = document.getElementById('clearAll');
    const modeHint = document.getElementById('modeHint');

    let currentTab = 'chat'; // 'chat' or 'image'
    let convos = [];
    let currentConvoId = null;

    // Create conversation
    function createConvo(name = 'New Conversation') {
      const id = 'c_' + Math.random().toString(36).slice(2,9);
      const convo = { id, name, messages: [] };
      convos.unshift(convo);
      currentConvoId = id;
      renderConvos();
      renderMessages();
    }

    function renderConvos() {
      convoListEl.innerHTML = '';
      convos.forEach((c) => {
        const card = document.createElement('div');
        card.className = 'convo fade-in';
        card.dataset.id = c.id;
        const initials = c.name.split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase();
        card.innerHTML = `
          <div class="avatar" aria-hidden>${initials}</div>
          <div style="flex:1">
            <strong style="display:block;color:var(--text)">${c.name}</strong>
            <small>${c.messages.length ? c.messages[c.messages.length-1].preview : 'Start the conversation'}</small>
          </div>
        `;
        card.addEventListener('click', () => {
          currentConvoId = c.id;
          renderMessages();
        });
        convoListEl.appendChild(card);
      });
    }

    function renderMessages() {
      const convo = convos.find(x => x.id === currentConvoId);
      messagesEl.innerHTML = '';
      if (!convo) {
        emptyState.style.display = 'flex';
        return;
      }
      if (!convo.messages.length) {
        emptyState.style.display = 'flex';
        return;
      }
      emptyState.style.display = 'none';
      convo.messages.forEach(m => {
        const el = document.createElement('div');
        el.className = 'msg ' + (m.role === 'user' ? 'user' : 'bot') + ' fade-in';
        if (m.isImage) {
          const title = document.createElement('div');
          title.style.fontWeight = '700';
          title.textContent = m.text || 'Generated image';
          el.appendChild(title);

          const img = document.createElement('img');
          img.src = m.imageUrl;
          img.alt = m.text || 'Generated image';
          el.appendChild(img);

          const actions = document.createElement('div');
          actions.className = 'image-actions';

          const dl = document.createElement('button');
          dl.className = 'small';
          dl.textContent = 'Download';
          dl.addEventListener('click', async () => {
            await downloadImage(m);
          });

          const open = document.createElement('button');
          open.className = 'small';
          open.textContent = 'Open';
          open.addEventListener('click', () => {
            window.open(m.imageUrl, '_blank');
          });

          actions.appendChild(dl);
          actions.appendChild(open);
          el.appendChild(actions);

        } else {
          el.textContent = m.text;
          const meta = document.createElement('div');
          meta.className = 'meta';
          const time = new Date(m.ts).toLocaleString();
          meta.innerHTML = `<time>${time}</time>`;
          el.appendChild(meta);
        }
        messagesEl.appendChild(el);
      });
      // scroll to bottom
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // message structure: {id, role, text, isImage, imageUrl, blob, ts, preview}
    function addMessage({role, text, isImage=false, imageUrl=null, blob=null}) {
      const convo = convos.find(x => x.id === currentConvoId);
      if (!convo) return null;
      const msg = {
        id: 'm_' + Math.random().toString(36).slice(2,9),
        role,
        text,
        isImage,
        imageUrl,
        blob,
        ts: Date.now(),
        preview: text ? (text.length>48 ? text.slice(0,45)+'...' : text) : (isImage ? 'Image' : '')
      };
      convo.messages.push(msg);
      renderConvos();
      renderMessages();
      return msg;
    }

    // Tab switching
    tabs.forEach(t => t.addEventListener('click', () => {
      tabs.forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      currentTab = t.dataset.tab;
      if (currentTab === 'image') {
        txtInput.placeholder = 'Enter image prompt (no /generate needed)';
        modeHint.textContent = 'Image Studio: prompt → generate → download';
      } else {
        txtInput.placeholder = 'Type a message... (text assistant)';
        modeHint.textContent = 'Chat mode: type and send for text response';
      }
      renderMessages();
      txtInput.focus();
    }));

    // API wrappers (unchanged endpoints)
    async function fetchTextResponse(prompt) {
      const endpoint = `https://text.pollinations.ai/openai/${encodeURIComponent(prompt)}`;
      const res = await fetch(endpoint);
      if (!res.ok) throw new Error('Text API error');
      const txt = await res.text();
      return txt;
    }

    // Returns a random integer between 1 and 999 (inclusive)
    function getRandomSeed() {
      return Math.floor(Math.random() * 999) + 1;
    }

    // Image URL builder now includes seed query parameter (?&seed=value) before nologo
    function buildImageUrl(prompt) {
      const encoded = encodeURIComponent(prompt);
      const seed = getRandomSeed();
      // seed is added before &nologo=true as requested
      return `https://image.pollinations.ai/prompt/flux/${encoded}?&seed=${seed}&nologo=true`;
    }

    // download logic: try fetch->blob, fallback to opening the url (CORS)
    async function downloadImage(msg) {
      try {
        if (msg.blob) {
          const url = URL.createObjectURL(msg.blob);
          triggerDownload(url, `ai_image_${msg.ts}.png`);
          URL.revokeObjectURL(url);
          return;
        }
        const resp = await fetch(msg.imageUrl, { mode: 'cors' });
        if (!resp.ok) throw new Error('Failed to fetch image for download');
        const blob = await resp.blob();
        msg.blob = blob;
        const url = URL.createObjectURL(blob);
        triggerDownload(url, `ai_image_${msg.ts}.png`);
        URL.revokeObjectURL(url);
      } catch (err) {
        console.warn('Download via fetch failed (CORS?), opening in new tab', err);
        window.open(msg.imageUrl, '_blank');
      }
    }

    function triggerDownload(objectUrl, filename) {
      const a = document.createElement('a');
      a.href = objectUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    // Send handler
    async function handleSend() {
      const text = txtInput.value.trim();
      if (!text) return;
      addMessage({ role:'user', text });
      txtInput.value = '';
      // show a generating/typing placeholder
      const placeholderText = currentTab === 'image' ? '🖼 Generating image…' : '🤔 Thinking…';
      const placeholder = addMessage({ role:'bot', text: placeholderText });

      if (currentTab === 'image') {
        // build image url & try to fetch blob
        try {
          const imgUrl = buildImageUrl(text);
          let blob = null;
          try {
            // try to fetch the generated image blob (CORS may block)
            const r = await fetch(imgUrl, { mode: 'cors' });
            if (r.ok) blob = await r.blob();
          } catch(e) {
            blob = null;
          }

           // remove placeholder
          const convo = convos.find(x => x.id === currentConvoId);
          if (convo) {
            const last = convo.messages[convo.messages.length - 1];
            if (last && last.id === placeholder.id) convo.messages.pop();
          }

          if (blob) {
            const objectUrl = URL.createObjectURL(blob);
            addMessage({ role:'bot', text, isImage:true, imageUrl:objectUrl, blob });
          } else {
            addMessage({ role:'bot', text, isImage:true, imageUrl:imgUrl });
          }
        } catch (err) {
          console.error(err);
          const convo = convos.find(x => x.id === currentConvoId);
          if (convo) {
            const last = convo.messages[convo.messages.length - 1];
            if (last && last.id === placeholder.id) convo.messages.pop();
          }
          addMessage({ role:'bot', text:'⚠️ Failed to generate image. Try again.' });
        }

      } else {
        // text generation
        try {
          const respText = await fetchTextResponse(text);
          const convo = convos.find(x => x.id === currentConvoId);
          if (convo) {
            const last = convo.messages[convo.messages.length - 1];
            if (last && last.id === placeholder.id) convo.messages.pop();
          }
          addMessage({ role:'bot', text: respText });
        } catch (err) {
          console.error(err);
          const convo = convos.find(x => x.id === currentConvoId);
          if (convo) {
            const last = convo.messages[convo.messages.length - 1];
            if (last && last.id === placeholder.id) convo.messages.pop();
          }
          addMessage({ role:'bot', text: '⚠️ Failed to get response. Try again.'});
        }
      }
    }

    // send events
    sendBtn.addEventListener('click', handleSend);
    txtInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    // conversation controls
    newConvoBtn.addEventListener('click', () => createConvo('Conversation ' + (convos.length+1)));
    startNew.addEventListener('click', () => createConvo('Conversation ' + (convos.length+1)));
    clearAllBtn.addEventListener('click', () => {
      if (!confirm('Clear all conversations?')) return;
      convos = [];
      currentConvoId = null;
      renderConvos();
      renderMessages();
    });

    // start initial conversation and onboarding message
    createConvo('Conversation 1');
    addMessage({ role:'bot', text: 'Hello! Switch to Image Studio to generate images (no /generate required). Try writing an image prompt.' });

    // focus input for convenience
    txtInput.focus();

    /* Accessibility: allow tab focus highlight for keyboard users only */
    (function(){
      let mouseUsed = false;
      window.addEventListener('mousedown', ()=> mouseUsed = true);
      window.addEventListener('keydown', (e)=> {
        if (e.key === 'Tab') mouseUsed = false;
      });
      document.addEventListener('focusin', (ev) => {
        if (!mouseUsed) {
          ev.target.style.outline = '2px solid rgba(76,201,240,0.18)';
          ev.target.style.outlineOffset = '2px';
        }
      });
      document.addEventListener('focusout', (ev) => {
        ev.target.style.outline = '';
        ev.target.style.outlineOffset = '';
      });
    })();

  </script>
</body>
</html>
