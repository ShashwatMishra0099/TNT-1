<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Chatbot — Text & Image Studio</title>

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f1724;
      --muted:#9aa4b2;
      --accent:#7dd3fc;
      --primary:#4cc9f0;
      --glass: rgba(255,255,255,0.03);
      --success:#16a34a;
      --danger:#f43f5e;
      --radius:14px;
      --card-shadow: 0 6px 18px rgba(2,6,23,0.6);
      --glass-border: rgba(255,255,255,0.04);
    }

    *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,"Helvetica Neue",Arial}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071026 0%, #06101b 100%);color:#e6eef8}
    a{color:var(--accent);text-decoration:none}
    header.site-header{
      display:flex;align-items:center;justify-content:space-between;
      gap:1rem;padding:18px 26px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-bottom:1px solid rgba(255,255,255,0.03);
      box-shadow: 0 4px 18px rgba(2,6,23,0.65);
      position:sticky;top:0;z-index:30;
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:42px;height:42px;border-radius:10px;
      background:linear-gradient(135deg,#0ea5e9,#7dd3fc);display:flex;align-items:center;justify-content:center;color:#022; font-weight:800;
      box-shadow: 0 6px 18px rgba(13,113,193,0.18);
    }
    .brand h1{font-size:16px;margin:0;color:#dff6ff}
    .brand p{margin:0;font-size:12px;color:var(--muted);margin-top:2px}

    /* Layout */
    .app {
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:20px;
      padding:20px;
      max-width:1200px;
      margin:18px auto;
      width:calc(100% - 48px);
    }

    /* Left column (conversations / quick actions) */
    .sidebar{
      background:var(--panel);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:var(--card-shadow);
      border:1px solid var(--glass-border);
      display:flex;flex-direction:column;gap:12px;
      min-height:520px;
    }
    .sidebar h2{font-size:13px;margin:0 0 6px 0;color:#e6eef8}
    .convo-list{display:flex;flex-direction:column;gap:10px;overflow:auto;padding-right:6px}
    .convo-card{
      display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;
      background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
      cursor:pointer;border:1px solid transparent;
      transition:all .15s;
    }
    .convo-card:hover{transform:translateY(-3px);box-shadow:0 8px 24px rgba(0,0,0,0.45)}
    .avatar{
      width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,#64748b,#111827);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;
    }
    .convo-meta{flex:1}
    .convo-meta small{display:block;color:var(--muted);font-size:12px}

    .sidebar .controls{display:flex;gap:8px;margin-top:auto}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);
      background:var(--glass);color:#e6eef8;font-weight:600;font-size:13px;cursor:pointer;
    }
    .btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,0.03);font-weight:500}
    .btn.primary{background:linear-gradient(90deg,var(--primary),var(--accent));color:#032;box-shadow:0 8px 20px rgba(34,197,94,0.06)}

    /* Main panel */
    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      border-radius:var(--radius);
      box-shadow:var(--card-shadow);
      border:1px solid var(--glass-border);
      display:flex;flex-direction:column;min-height:520px;overflow:hidden;
    }

    /* Tabs */
    .tabs{
      display:flex;gap:10px;padding:14px;border-bottom:1px solid rgba(255,255,255,0.02);
      align-items:center;background:transparent;
    }
    .tab{
      padding:8px 12px;border-radius:10px;font-weight:700;font-size:13px;color:var(--muted);cursor:pointer;
      border:1px solid transparent;
    }
    .tab.active{background:linear-gradient(90deg, rgba(125,211,252,0.08), rgba(76,201,240,0.04));color:var(--accent);border:1px solid rgba(125,211,252,0.08)}

    /* Chat area */
    .chat-area{display:flex;flex-direction:column;gap:12px;padding:18px;flex:1;overflow:hidden}
    .messages{flex:1;overflow:auto;padding:6px 6px 12px 6px;display:flex;flex-direction:column;gap:12px}
    .message{
      max-width:78%;padding:12px 14px;border-radius:14px;line-height:1.4;font-size:14px;
      box-shadow: 0 6px 18px rgba(2,6,23,0.5);
    }
    .message.user{margin-left:auto;background:linear-gradient(180deg,#0ea5e9,#7dd3fc);color:#032;border-bottom-right-radius:6px}
    .message.bot{margin-right:auto;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));color:#dff6ff;border-bottom-left-radius:6px;border:1px solid rgba(255,255,255,0.02)}
    .meta{display:flex;gap:8px;align-items:center;font-size:12px;color:var(--muted);margin-top:6px}
    .meta time{opacity:0.85}

    /* Image bubble */
    .message img{
      display:block;max-width:100%;border-radius:10px;margin-top:8px;
      box-shadow: 0 8px 30px rgba(3,7,18,0.6);
    }
    .image-actions{display:flex;gap:8px;margin-top:8px;align-items:center}
    .small-btn{padding:6px 8px;border-radius:8px;font-size:13px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);cursor:pointer}

    /* Input area */
    .composer{
      display:flex;gap:12px;padding:14px;border-top:1px solid rgba(255,255,255,0.02);background:linear-gradient(180deg, transparent, rgba(255,255,255,0.005));
      align-items:center;
    }
    .composer input[type="text"]{
      flex:1;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);
      background:rgba(0,0,0,0.25);color:#e6eef8;font-size:15px;outline:none;
    }
    .composer .actions{display:flex;gap:8px}
    .send-btn{padding:10px 14px;border-radius:10px;background:linear-gradient(90deg,var(--primary),var(--accent));border:none;color:#032;font-weight:700;cursor:pointer}
    .icon-btn{width:44px;height:44px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);display:inline-flex;align-items:center;justify-content:center;background:transparent;cursor:pointer}

    /* empty / hint */
    .empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px;color:var(--muted);gap:12px;text-align:center}
    .hint{padding:10px 12px;border-radius:10px;background:rgba(125,211,252,0.03);color:var(--accent);font-weight:600;border:1px solid rgba(125,211,252,0.05)}

    /* small screens */
    @media (max-width:900px){
      .app{grid-template-columns:1fr; padding:12px}
      .sidebar{order:2}
    }
  </style>
</head>
<body>
  <header class="site-header" role="banner">
    <div class="brand">
      <div class="logo">AI</div>
      <div>
        <h1>AI Chatbot</h1>
        <p>Text assistant • Image Studio</p>
      </div>
    </div>

    <div style="display:flex;gap:10px;align-items:center">
      <small style="color:var(--muted);font-weight:600">Connected</small>
      <button class="btn ghost" title="New conversation" id="newConvoBtn">+ New</button>
    </div>
  </header>

  <main class="app" role="main">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="conversations">
      <h2>Conversations</h2>
      <div class="convo-list" id="convoList">
        <!-- Dynamic conversation cards -->
      </div>

      <div class="controls">
        <button class="btn" id="clearAll">Clear</button>
        <button class="btn primary" id="startNew">Start Chat</button>
      </div>
    </aside>

    <!-- Main panel -->
    <section class="panel" aria-live="polite">
      <div class="tabs" role="tablist">
        <div class="tab active" data-tab="chat" role="tab" id="tab-chat">💬 Chat</div>
        <div class="tab" data-tab="image" role="tab" id="tab-image">🖼 Image Studio</div>
        <div style="margin-left:auto" class="hint" id="modeHint">Tip: Use Image Studio to generate and download images.</div>
      </div>

      <!-- Chat area -->
      <div class="chat-area" id="chatArea">
        <div class="messages" id="messages">
          <div class="empty-state" id="empty">
            <div style="font-size:20px;font-weight:700">Welcome — choose a tab to begin</div>
            <div style="max-width:420px;color:var(--muted)">Use <strong>Chat</strong> for text responses and <strong>Image Studio</strong> to generate images directly (no "/generate"). Each generated image includes a download button.</div>
          </div>
        </div>

        <div class="composer" id="composer">
          <input type="text" id="txtInput" placeholder="Type a message..." autocomplete="off" />
          <div class="actions">
            <button class="icon-btn" id="attachBtn" title="Attach (not implemented)">
              <!-- small paperclip icon -->
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M21 12.5V6a5 5 0 0 0-10 0v7a3 3 0 0 0 6 0V7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" opacity="0.7"/></svg>
            </button>
            <button class="send-btn" id="sendBtn">Send</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // -------------------------
    // Simple in-memory conversation store
    // -------------------------
    const convoListEl = document.getElementById('convoList');
    const messagesEl = document.getElementById('messages');
    const emptyState = document.getElementById('empty');
    const tabs = document.querySelectorAll('.tab');
    const composer = document.getElementById('composer');
    const txtInput = document.getElementById('txtInput');
    const sendBtn = document.getElementById('sendBtn');
    const newConvoBtn = document.getElementById('newConvoBtn');
    const startNew = document.getElementById('startNew');
    const clearAllBtn = document.getElementById('clearAll');
    const modeHint = document.getElementById('modeHint');

    let currentTab = 'chat'; // 'chat' or 'image'
    let convos = [];
    let currentConvoId = null;

    // Create an initial conversation
    function createConvo(name = 'New Conversation') {
      const id = 'c_' + Math.random().toString(36).slice(2,9);
      const convo = { id, name, messages: [] };
      convos.unshift(convo);
      currentConvoId = id;
      renderConvos();
      renderMessages();
    }

    function renderConvos() {
      convoListEl.innerHTML = '';
      convos.forEach((c) => {
        const card = document.createElement('div');
        card.className = 'convo-card';
        card.dataset.id = c.id;
        card.innerHTML = `
          <div class="avatar">${c.name.split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase()}</div>
          <div class="convo-meta">
            <strong style="display:block;color:#e6eef8">${c.name}</strong>
            <small>${c.messages.length ? c.messages[c.messages.length-1].preview : 'Start the conversation'}</small>
          </div>
        `;
        card.addEventListener('click', () => {
          currentConvoId = c.id;
          renderMessages();
        });
        convoListEl.appendChild(card);
      });
    }

    // message structure: {id, role: 'user'|'bot', text, isImage, imageUrl, blob, ts, preview}
    function renderMessages() {
      const convo = convos.find(x => x.id === currentConvoId);
      messagesEl.innerHTML = '';
      if (!convo) {
        emptyState.style.display = 'flex';
        return;
      }
      if (!convo.messages.length) {
        emptyState.style.display = 'flex';
      } else {
        emptyState.style.display = 'none';
        convo.messages.forEach(m => {
          const div = document.createElement('div');
          div.className = 'message ' + (m.role === 'user' ? 'user' : 'bot');
          if (m.isImage) {
            // image bubble
            const caption = document.createElement('div');
            caption.textContent = m.text || 'Generated image';
            caption.style.fontWeight = '700';
            div.appendChild(caption);

            const img = document.createElement('img');
            img.src = m.imageUrl;
            img.alt = m.text || 'Generated image';
            div.appendChild(img);

            const actions = document.createElement('div');
            actions.className = 'image-actions';

            const dlBtn = document.createElement('button');
            dlBtn.className = 'small-btn';
            dlBtn.textContent = 'Download';
            dlBtn.title = 'Download image';
            dlBtn.addEventListener('click', async () => {
              await downloadImage(m);
            });

            const openBtn = document.createElement('button');
            openBtn.className = 'small-btn';
            openBtn.textContent = 'Open';
            openBtn.addEventListener('click', () => {
              window.open(m.imageUrl, '_blank');
            });

            actions.appendChild(dlBtn);
            actions.appendChild(openBtn);
            div.appendChild(actions);

          } else {
            div.textContent = m.text;
            if (m.preview) {
              const meta = document.createElement('div');
              meta.className = 'meta';
              meta.innerHTML = `<time>${new Date(m.ts).toLocaleString()}</time>`;
              div.appendChild(meta);
            }
          }
          messagesEl.appendChild(div);
        });
        // scroll to bottom
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }
    }

    // Helpers to append message to current convo
    function addMessage({role, text, isImage=false, imageUrl=null, blob=null}) {
      const convo = convos.find(x => x.id === currentConvoId);
      if (!convo) return;
      const msg = {
        id: 'm_' + Math.random().toString(36).slice(2,9),
        role,
        text,
        isImage,
        imageUrl,
        blob,
        ts: Date.now(),
        preview: text ? (text.length>40 ? text.slice(0,37)+'...' : text) : (isImage ? 'Image' : '')
      };
      convo.messages.push(msg);
      renderConvos();
      renderMessages();
      return msg;
    }

    // -------------------------
    // Tab switching & composer behavior
    // -------------------------
    tabs.forEach(t => t.addEventListener('click', () => {
      tabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      currentTab = t.dataset.tab;
      if (currentTab === 'image') {
        txtInput.placeholder = 'Enter image prompt (no /generate needed)';
        modeHint.textContent = 'Image Studio: prompt -> generate -> download';
      } else {
        txtInput.placeholder = 'Type a message... (text assistant)';
        modeHint.textContent = 'Chat: type and press Send for text responses';
      }
      // Clear the message list if there is no conversation? keep same convo
      renderMessages();
    }));

    // -------------------------
    // API endpoints (as in your original)
    // -------------------------
    // Text generation endpoint (unchanged)
    async function fetchTextResponse(prompt) {
      // using the same text.pollinations.ai endpoint you had
      const endpoint = `https://text.pollinations.ai/openai/${encodeURIComponent(prompt)}`;
      const res = await fetch(endpoint);
      if (!res.ok) throw new Error('Text API error');
      // endpoint returned text in your example
      const txt = await res.text();
      return txt;
    }

    // Image generation: builds the image URL and tries to fetch blob for download.
    // Base URL pattern used in your original: https://image.pollinations.ai/prompt/flux/{encodedPrompt}?&nologo=true
    function buildImageUrl(prompt) {
      const encoded = encodeURIComponent(prompt);
      return `https://image.pollinations.ai/prompt/flux/${encoded}?&nologo=true`;
    }

    // Attempt to download via fetch->blob; if CORS blocks, fallback to opening the image URL in new tab
    async function downloadImage(msg) {
      try {
        if (msg.blob) {
          // blob already present (faster)
          const url = URL.createObjectURL(msg.blob);
          triggerDownload(url, `ai_image_${msg.ts}.png`);
          URL.revokeObjectURL(url);
          return;
        }
        // try to fetch the image as blob
        const resp = await fetch(msg.imageUrl, {mode:'cors'});
        if (!resp.ok) throw new Error('Failed to fetch image for download');
        const blob = await resp.blob();
        msg.blob = blob; // cache it
        const url = URL.createObjectURL(blob);
        triggerDownload(url, `ai_image_${msg.ts}.png`);
        URL.revokeObjectURL(url);
      } catch (err) {
        console.warn('Download via fetch failed (CORS?):', err);
        // fallback: open new tab where user can right-click -> save (download attribute may not work cross-origin)
        window.open(msg.imageUrl, '_blank');
      }
    }

    function triggerDownload(objectUrl, filename) {
      const a = document.createElement('a');
      a.href = objectUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    // -------------------------
    // Send button / Enter handling
    // -------------------------
    async function handleSend() {
      const text = txtInput.value.trim();
      if (!text) return;
      // Save user's message
      addMessage({role:'user', text});
      txtInput.value = '';
      // UI feedback
      addMessage({role:'bot', text: currentTab==='image' ? '🖼 Generating image…' : '🤔 Thinking…'});

      if (currentTab === 'image') {
        // generate image
        try {
          const imgUrl = buildImageUrl(text);
          // Try to fetch blob first (for reliable display and download) — but don't wait too long
          // We'll perform two tasks:
          // 1) set the image url for display (object URL if blob fetched), and store blob if possible
          // 2) replace the 'generating' placeholder message with final image
          let blob = null;
          try {
            const r = await fetch(imgUrl, {mode:'cors'});
            if (r.ok) {
              blob = await r.blob();
            }
          } catch(e){
            // fetch failed (CORS or network) — we'll still display the direct URL
            blob = null;
          }

          // remove the temporary 'Generating image…' last bot message
          const convo = convos.find(x => x.id === currentConvoId);
          if (convo) {
            // remove last bot placeholder
            const last = convo.messages[convo.messages.length - 1];
            if (last && last.role === 'bot' && (last.text.includes('Generating') || last.text.includes('Thinking'))) {
              convo.messages.pop();
            }
          }

          // If blob available, create object URL for display
          if (blob) {
            const objectUrl = URL.createObjectURL(blob);
            addMessage({role:'bot', text, isImage:true, imageUrl:objectUrl, blob});
          } else {
            // fallback: use direct image URL (may be cross-origin)
            addMessage({role:'bot', text, isImage:true, imageUrl:imgUrl});
          }
        } catch (err) {
          console.error(err);
          // replace placeholder with error
          addMessage({role:'bot', text:'⚠️ Failed to generate image. Try again.'});
        }

      } else {
         // text generation
        try {
          const respText = await fetchTextResponse(text);
          // remove the temporary 'Thinking..' message
          const convo = convos.find(x => x.id === currentConvoId);
          if (convo) {
            const last = convo.messages[convo.messages.length - 1];
            if (last && last.role === 'bot' && last.text.includes('Thinking')) {
              convo.messages.pop();
            }
          }
          addMessage({role:'bot', text:respText});
        } catch (err) {
          console.error(err);
          // replace placeholder with error
          const convo = convos.find(x => x.id === currentConvoId);
          if (convo) {
            const last = convo.messages[convo.messages.length - 1];
            if (last && last.role === 'bot' && last.text.includes('Thinking')) {
              convo.messages.pop();
            }
          }
          addMessage({role:'bot', text:'⚠️ Failed to get response. Try again.'});
        }
      }
    }

    sendBtn.addEventListener('click', handleSend);
    txtInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    // New conversation handlers
    newConvoBtn.addEventListener('click', () => {
      createConvo('Conversation ' + (convos.length+1));
    });
    startNew.addEventListener('click', () => {
      createConvo('Conversation ' + (convos.length+1));
    });
    clearAllBtn.addEventListener('click', () => {
      if (!confirm('Clear all conversations?')) return;
      convos = [];
      currentConvoId = null;
      renderConvos();
      renderMessages();
    });

    // Start with one conversation
    createConvo('Conversation 1');

    // Quick demo messages
    addMessage({role:'bot', text: 'Hello! Switch to Image Studio to generate images (no /generate required).', isImage:false});

    // Accessibility: focus input
    txtInput.focus();
  </script>
</body>
</html>
